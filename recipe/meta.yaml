{% set version = "9.0.3" %}
{% set build_number = 4 %}

{% set major_minor = ".".join(version.split(".")[:2]) %}

{% set build_number = build_number + 200 %}   # [not VTK_WITH_OSMESA]

package:
  name: vtk
  version: {{ version }}

source:
  url: https://www.vtk.org/files/release/{{ major_minor }}/VTK-{{ version }}.tar.gz
  sha256: bc3eb9625b2b8dbfecb6052a2ab091fc91405de4333b0ec68f3323815154ed8a
  patches:
    # The tbb_stddef.h does not exist in recent releases, instead take the
    # version from version.h
    - use-tbb-version-h-instead-of-stddef-h.patch
    # tbb::task_scheduler_init has been deprecated since Intel TBB 4.3 Update 5
    # and in the new Intel oneTBB 2021.x releases it is finally completely gone.
    #
    # By default, Intel TBB automatically creates a task scheduler the first
    # time that a thread uses task scheduling services and destroys it when the
    # last such thread exits.
    - no-explicit-task-scheduler.patch
    # tbb::atomic was deprecated and removed, replace it with std::atomic.
    - use-std-atomic-instead-of-tbb-atomic.patch
    - numeric_limits.patch

build:
  skip: True  # [win32 or s390x or ppc64le]
  number: {{ build_number }}
  features:
    - mesalib   # [VTK_WITH_OSMESA]
  missing_dso_whitelist:
    - '*/ld-linux-*.so.*'
    - '*/libc.so.*'
    - '*/libdl.so.*'
    - '*/libm.so.*'
    - '*/libpthread.so.*'
    - '*/libvtk*.dylib'
  run_exports:
    - {{ pin_subpackage('vtk', max_pin='x.x.x') }}

requirements:
  build:
    - {{ compiler("cxx") }}
    - cmake
    - ninja
    - patch  # [not win]
    - m2-patch  # [win]
    - pugixml
  {% if SUBDIR in ('linux-64', 'linux-32', 'linux-ppc64le', 'linux-aarch64') %}
    - {{ cdt('libxcb') }}
    - {{ cdt('libxau') }}
    - {{ cdt('libxau') }}
    - {{ cdt('libuuid') }}
    - {{ cdt('libxext') }}
    - {{ cdt('libxfixes') }}
    - {{ cdt('libxxf86vm') }}
    - {{ cdt('libxdamage') }}
    - {{ cdt('libselinux') }}
    - {{ cdt('libsm-devel') }}
    - {{ cdt('libxt-devel') }}
    - {{ cdt('libice-devel') }}
    - {{ cdt('libx11-devel') }}
    - {{ cdt('mesa-libgl-devel') }}
    - {{ cdt('mesa-dri-drivers') }}
    - {{ cdt('xorg-x11-proto-devel') }}
  {% endif %}
  host:
    - python
    # VTK Third Party dependencies
    - zlib
    - freetype
    - hdf5
    - libxml2 2.10
    - libpng
    - jpeg
    - libtiff
    - jsoncpp
    - expat
    # Limit TBB version. The oneAPI (2021.*) release removed the `tbb_stddef.h`
    # header, which causes configure-time errors. The 2020 release is probably
    # safe to use but generates *tons* of deprecation warnings that (may) hint
    # at subtle breaks. Given all that, we set the limit to the latest version
    # available when VTK 8.2 was released.
    - tbb
    - tbb-devel 2021.8.0
    - mesalib  # [VTK_WITH_OSMESA]
    - libnetcdf
    - lz4-c
    - boost-cpp
    - tk  # [not win and not VTK_WITH_OSMESA]
    - ffmpeg
    - utfcpp 3.2.1
    - eigen 3.3.7
    - double-conversion 3.1.5
    - glew
    - libogg 1.3.5
    - libtheora
    - proj 9.3.1
    - loguru 0.5.3
    - sqlite
    - gl2ps
    # We have an (experimental?) Qt 6.1 build available on osx-arm64,
    # but for the sake of coherence, we pin to 5 across all variants.
    - qt =5
    - xz
  run:
    - python
    - zlib
    - freetype
    - hdf5
    - libxml2 >=2.10.3,<2.11.0a0
    - libpng
    - jpeg
    - libtiff
    - jsoncpp
    - expat
    - tbb
    - mesalib  # [VTK_WITH_OSMESA]
    - libnetcdf
    - lz4-c
    - tk  # [not win and not VTK_WITH_OSMESA]
    - ffmpeg
    - {{ pin_compatible('utfcpp') }}
    - {{ pin_compatible('eigen') }}
    - {{ pin_compatible('double-conversion') }}
    - glew
    - libogg
    - libtheora
    - proj
    - {{ pin_compatible('loguru') }}
    - sqlite
    - gl2ps
    # Not all our Qt builds in distribution seem to export a pinning.
    - {{ pin_compatible('qt') }}
    - xz

  run_constrained:
    # Paraview bundles its own VTK that has conflicting Python vtkmodules
    - paraview ==9999999999

test:
  requires:
    - setuptools
    - python

about:
  home: https://vtk.org/
  license: BSD-3-Clause
  license_family: BSD
  license_file: Copyright.txt
  summary: >
    VTK is an open-source software system designed for 3D computer graphics, image processing, 
    and visualization. It provides libraries and tools for developing scientific and 
    engineering applications that require 3D visualization.
  description: |
    VTK, or Visualization Toolkit, is an open-source software system designed for 3D computer graphics, 
    image processing, and visualization. It provides a wide range of libraries and tools that are useful 
    for developing scientific and engineering applications that require 3D visualization, such as medical 
    imaging, computational fluid dynamics, and data visualization. The package supports a wide range of 
    visualization algorithms and techniques, including volume rendering, isosurface extraction, contouring, 
    and glyphs. VTK is implemented in C++ with Python bindings, and includes pre-built classes and functions 
    for manipulating and visualizing data. The package has been used in various applications, including 
    medical imaging, computational fluid dynamics, molecular modeling, and geospatial data visualization.
  dev_url: https://gitlab.kitware.com/vtk/vtk
  doc_url: https://vtk.org/documentation/

extra:
  recipe-maintainers:
    - Korijn
    - ivoflipse
    - Maxyme
    - ccordoba12
    - grlee77
    - msarahan
    - patricksnape
    - dfroger
    - tadeu
    - marcelotrevisani
